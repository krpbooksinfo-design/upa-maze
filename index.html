<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ウパ迷路オンライン</title>
<style>
html,body{margin:0;height:100%;overflow:hidden;background:#222}
#wrap{height:100%;display:flex;flex-direction:column}
#game{flex:1;display:flex;justify-content:center;align-items:center}
canvas{background:#fff}
#footer{
  height:140px;background:#111;color:#fff;
  display:flex;align-items:center;justify-content:center;gap:32px
}
.ctrl{
  display:grid;
  grid-template-columns:70px 70px 70px;
  grid-template-rows:70px 70px;
  gap:8px
}
button{
  font-size:26px;border:none;border-radius:12px;
  background:#444;color:#fff
}
#compass{
  width:70px;height:70px;border:2px solid #fff;border-radius:50%;
  position:relative
}
#needle{
  position:absolute;left:50%;top:50%;
  width:4px;height:30px;background:red;
  transform-origin:bottom center;
}
</style>
</head>
<body>
<div id="wrap">
  <div id="game">
    <canvas id="cv" width="700" height="700"></canvas>
  </div>
  <div id="footer">
    <div class="ctrl">
      <div></div><button id="up">↑</button><div></div>
      <button id="left">←</button><button id="down">↓</button><button id="right">→</button>
    </div>
    <div id="compass"><div id="needle"></div></div>
  </div>
</div>

<script>
/* ===== 極限難度・自動生成迷路 ===== */
const W = 61, H = 61; // 奇数
const maze = Array.from({length:H},()=>Array(W).fill(1));

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}

function carve(x,y){
  const dirs=[[2,0],[-2,0],[0,2],[0,-2]];
  shuffle(dirs);
  for(const [dx,dy] of dirs){
    const nx=x+dx, ny=y+dy;
    if(ny>0 && ny<H-1 && nx>0 && nx<W-1 && maze[ny][nx]===1){
      maze[ny][nx]=0;
      maze[y+dy/2][x+dx/2]=0;
      carve(nx,ny);
    }
  }
}

maze[1][1]=0;
carve(1,1);
const goal={x:W-2,y:H-2};
maze[goal.y][goal.x]=0;

/* ===== 描画・操作 ===== */
const TILE = 30;
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");

let px=1, py=1;

function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  const ox=cv.width/2-px*TILE-TILE/2;
  const oy=cv.height/2-py*TILE-TILE/2;

  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      if(maze[y][x]){
        ctx.fillStyle="#000";
        ctx.fillRect(x*TILE+ox,y*TILE+oy,TILE,TILE);
      }
    }
  }

  ctx.fillStyle="gold";
  ctx.fillRect(goal.x*TILE+ox,goal.y*TILE+oy,TILE,TILE);

  ctx.fillStyle="red";
  ctx.beginPath();
  ctx.arc(px*TILE+ox+TILE/2,py*TILE+oy+TILE/2,10,0,Math.PI*2);
  ctx.fill();

  const dx=goal.x-px, dy=goal.y-py;
  const ang=Math.atan2(dy,dx)+Math.PI/2;
  document.getElementById("needle").style.transform=
    `translate(-50%,-100%) rotate(${ang}rad)`;
}

function move(dx,dy){
  const nx=px+dx, ny=py+dy;
  if(maze[ny] && maze[ny][nx]===0){
    px=nx; py=ny;
    if(px===goal.x && py===goal.y){
      alert("GOAL!!");
      px=1; py=1;
    }
    draw();
  }
}

document.getElementById("up").onmousedown=()=>move(0,-1);
document.getElementById("down").onmousedown=()=>move(0,1);
document.getElementById("left").onmousedown=()=>move(-1,0);
document.getElementById("right").onmousedown=()=>move(1,0);

window.addEventListener("keydown",e=>{
  if(e.key==="ArrowUp")move(0,-1);
  if(e.key==="ArrowDown")move(0,1);
  if(e.key==="ArrowLeft")move(-1,0);
  if(e.key==="ArrowRight")move(1,0);
});

draw();
</script>
</body>
</html>
